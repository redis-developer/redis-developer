<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-create/redis-functions/index-redis-functions">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Getting started with Redis Functions | The Home of Redis Developers</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://developer.redis.com/img/redis-hero-image.jpg"><meta data-rh="true" name="twitter:image" content="https://developer.redis.com/img/redis-hero-image.jpg"><meta data-rh="true" property="og:url" content="https://developer.redis.com/create/redis-functions"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Getting started with Redis Functions | The Home of Redis Developers"><meta data-rh="true" name="description" content="The most impactful addition to Redis version 7.0 is Redis Functions - a new programmability option, improving on scripts by adding modularity, reusability, and better overall developer experience."><meta data-rh="true" property="og:description" content="The most impactful addition to Redis version 7.0 is Redis Functions - a new programmability option, improving on scripts by adding modularity, reusability, and better overall developer experience."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://developer.redis.com/create/redis-functions"><link data-rh="true" rel="alternate" href="https://developer.redis.com/create/redis-functions" hreflang="en"><link data-rh="true" rel="alternate" href="https://developer.redis.com/create/redis-functions" hreflang="x-default"><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-W8Z6BLQ",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><link rel="stylesheet" href="/assets/css/styles.b5561ee1.css">
<link rel="preload" href="/assets/js/runtime~main.31923179.js" as="script">
<link rel="preload" href="/assets/js/main.d3d68f51.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W8Z6BLQ" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:rgb(210, 215, 254);color:rgb(22 31 49)" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><div class="announcement-bar"><a href="https://redis.com/blog/introducing-redis-7-2/" target="_blank" rel="noopener"><span>Announcing Redis 7.2 and Enhanced Vector DB</span> <span style="margin-left:1rem">Learn more</span> <span style="margin-left:0.25rem">→</span></a></div></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-1.png" alt="Redis Developer Hub logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-1.png" alt="Redis Developer Hub logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"><div id="redis-sitesearch" class="redis-sitesearch redis-sitesearch-inline"><input class="redis-sitesearch-input"><div class="redis-sitesearch-result-list-wrapper"><ul class="redis-sitesearch-result-list"></ul><div class="redisearch-logo"></div></div></div></div><a class="navbar__item navbar__link" href="/howtos/quick-start">Get started</a><a href="https://launchpad.redis.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Redis Launchpad<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://redis.com/try-free/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Try Free<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo-1.png" alt="Redis Developer Hub logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-1.png" alt="Redis Developer Hub logo" class="themedImage_ToTc themedImage--dark_i4oU"></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Home</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/howtos/quick-start">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/create">Create</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/create">Overview - All Quick Starts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/create/redis-functions">Redis Functions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/create/azure">Redis on Azure Cache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/create/aws">Redis on AWS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/create/docker/">Redis on Docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/create/kubernetes/">Redis on Kubernetes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/create/windows">Redis on Windows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/create/jenkins">Redis using Jenkins</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/create/azurefunctions">Redis using Azure Functions</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/develop">Develop</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/explore">Explore</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/operate/observability/redisdatasource">Operate</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/howtos/quick-start/cheat-sheet">HowTos &amp; Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/community/">Get Involved</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ebooks/8-nosql-data-modeling-patterns">E-books</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Create</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Redis Functions</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Getting started with Redis Functions</h1><div class="docAuthors"><hr><div class="authorByline_VoxI"><img class="authorProfileImage_URwT" src="/img/profile_pic_elena_kolevska.jpg" alt="Profile picture for Elena Kolevska"><div><div class="authorLabel_a70t">Author:</div><div><a href="https://twitter.com/elena_kolevska" target="_blank">Elena Kolevska</a>, <!-- -->Technical Enablement Manager, EMEA at Redis</div></div></div><hr></div><p>The most impactful addition to Redis version 7.0 is <strong>Redis Functions</strong> - a new programmability option, improving on scripts by <strong>adding modularity, reusability, and better overall developer experience</strong>.</p><p>Functions are, in contrast to scripts, persisted in the .rdb and .aof files as well as automatically replicated to all the replicas, which makes them a first-class citizen of Redis.</p><p>Redis has the capability of supporting multiple execution engines so in one of the future releases we’ll be able to write Redis Functions in Lua, Javascript, and more languages, but at the moment (Redis v7.0) the only supported language is Lua.</p><p>A common pain point for developers is to maintain a consistent view of data entities through a logical schema. Redis Functions are ideally suited for solving this problem and in this tutorial, we will demonstrate just that - we’ll create a library with two functions; the first one will make sure that we can automatically set <code>_created_at</code> and <code>_updated_at</code> timestamps for hash keys and the second one will simply update the <code>_updated_at</code> timestamp without changing the other elements, simulating the “touch” Unix function. Let&#x27;s go!</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="environment-setup">Environment setup<a class="hash-link" href="#environment-setup" title="Direct link to heading">​</a></h3><p>First, let’s set up a working environment with Redis 7. You can follow the installation instructions in the guides below, according to your operating system:</p><ul><li><a href="https://redis.io/docs/getting-started/installation/install-redis-from-source/" target="_blank" rel="noopener noreferrer">Install Redis from Source</a></li><li><a href="https://redis.io/docs/getting-started/installation/install-redis-on-linux/" target="_blank" rel="noopener noreferrer">Install Redis on Linux</a></li><li><a href="https://redis.io/docs/getting-started/installation/install-redis-on-mac-os/" target="_blank" rel="noopener noreferrer">Install Redis on macOS</a></li><li><a href="https://redis.io/docs/getting-started/installation/install-redis-on-windows/" target="_blank" rel="noopener noreferrer">Install Redis on Windows</a></li></ul><p>Alternatively, you can spin up a Docker container with Redis Stack:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ docker run -p 6379:6379 --name redis-7.0 -it --rm redis/redis-stack:7.0.0-RC4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>In the rest of this tutorial we’ll use the <code>$</code> character to indicate that the command needs to be run on the command prompt and <code>redis-cli&gt;</code> to indicate the same for a redis-cli prompt.</p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="warm-up">Warm-Up<a class="hash-link" href="#warm-up" title="Direct link to heading">​</a></h3><p>Now that we have our Redis server running, we can create a file named <code>mylib.lua</code> and in it create a function named <code>hset</code> that would receive the keys and arguments we pass on the command line as parameters.</p><p><strong><em>Functions in Redis are always a part of a library, and a single library can have multiple functions. </em></strong></p><p>For starters, let&#x27;s create a simple function that returns &quot;Hello Redis 7.0&quot; and save it in the <code>mylib.lua</code> file.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return &quot;Hello Redis 7.0&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The first line specifies that we want to use the Lua engine to run this function and that its name is <code>mylib</code>.The name is the library identifier and we will use it every time we need to update it.</p><p>Next, we need to register this function so it can be accessed through the Functions api. In the registration we specify that the function <code>hset</code> can be called with the name of <code>my_hset</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The full code, so far, is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return &quot;Hello Redis 7.0&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before we can call the function on the command line, we need to load and register it with the Redis server:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/mylib.lua | redis-cli -x FUNCTION LOAD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, let’s run the function we registered:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 foo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see the greeting &quot;Hello Redis 7.0&quot; as a response.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="maintaining-a-consistent-view-of-data-entities-through-a-logical-schema">Maintaining a consistent view of data entities through a logical schema<a class="hash-link" href="#maintaining-a-consistent-view-of-data-entities-through-a-logical-schema" title="Direct link to heading">​</a></h3><p>We&#x27;re now ready to start working on the requirement. First, let&#x27;s implement the part that adds an <code><em><em>updated</em></em>at</code> timestamp:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]  -- Get the current time from the Redis server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Add the current timestamp to the arguments that the user passed to the function, stored in `args`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, &#x27;_updated_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Run HSET with the updated argument list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, hash, unpack(args))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After you updated the code, you will have to reload the library in the Redis server, using the <code>replace</code> argument to specify that you want to overwrite the previous version:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/mylib.lua | redis-cli -x FUNCTION LOAD REPLACE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you try to create and update a hash through our function now, you will see that a timestamp is automatically added to it:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 foo k1 v1 k2 v2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; HGETALL foo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1) &quot;k1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2) &quot;v1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3) &quot;k2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4) &quot;v2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5) &quot;_updated_at&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">6) &quot;1643581494&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we try to update the same key, we will see that the <code>_updated_at</code> timestamp got updated too:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 foo k4 v4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; HGETALL foo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1) &quot;k1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2) &quot;v1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3) &quot;k2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4) &quot;v2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5) &quot;_updated_at&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">6) &quot;1643581580&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7) &quot;k4&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">8) &quot;v4&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s add the logic that checks if the key is being created or updated, and adds the <code>_created_at</code> timestamp accordingly:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]  -- Get the current time from the Redis server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Check if the key exists and if not - add a `_created_at` timestamp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local exists = redis.call(&#x27;exists&#x27;, hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if exists==0 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, &#x27;_created_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Add the current timestamp to the arguments that the user passed to the function, stored in `args`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, &#x27;_updated_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Run HSET with the updated argument list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, hash, unpack(args))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Reload the library:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/mylib.lua | redis-cli -x FUNCTION LOAD REPLACE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And try to create a new key:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 bar k1 v1 k2 v2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; HGETALL bar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1) &quot;k1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2) &quot;v1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3) &quot;k2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4) &quot;v2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5) &quot;_updated_at&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">6) &quot;1643581710&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7) &quot;_created_at&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">8) &quot;1643581710&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Both a <code>_created_at</code> and <code>_updated_at</code> timestamps were added. If we update the key, we will see that the <code>_updated_at</code> timestamp will change, while the <code>_created_at</code> will stay the same:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 bar k4 v4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; HMGET bar _created_at _updated_at</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1) &quot;1643581710&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2) &quot;1643581992&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The second requirement was to implement a function that will allow us to update the <code>_updated_at</code> timestamp without updating any other fields. For that, we&#x27;ll have to create a new function in our library:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function touch(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, keys[1], &#x27;_updated_at&#x27;, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And we should also add the function registration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_touch&#x27;, touch)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The full code will now look like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]  -- Get the current time from the Redis server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local exists = redis.call(&#x27;exists&#x27;, hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if exists==0 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, &#x27;_created_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Add the current timestamp to the arguments that the user passed to the function, stored in `args`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, &#x27;_updated_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Run HSET with the updated argument list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, hash, unpack(args))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function touch(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, keys[1], &#x27;_updated_at&#x27;, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_touch&#x27;, touch)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Reload the updated library:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/mylib.lua | redis-cli -x FUNCTION LOAD REPLACE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And try running the new function and confirm that the <code>_updated_at</code> timestamp has indeed changed:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_touch 1 bar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; HMGET bar _created_at _updated_at</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1) &quot;1643581710&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2) &quot;1643582276&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="thinking-ahead">Thinking ahead<a class="hash-link" href="#thinking-ahead" title="Direct link to heading">​</a></h3><p>One of the basic rules of software development is that you cannot rely on user input, so let’s make sure we don’t do that. If a user creates a string named <code>my_string</code> and tries to run the touch function on it they will get an error:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; SET my_string hello</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 my_string k1 v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">(error) WRONGTYPE Operation against a key holding the wrong kind of value script: my_hset, on @user_function:17.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let’s handle this error by adding a type check:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if exists==1 and redis.call(&#x27;TYPE&#x27;, hash)[&quot;ok&quot;] ~= &#x27;hash&#x27; then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   error = &#x27;The key &#x27; .. hash .. &#x27; is not a hash&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   redis.log(redis.LOG_WARNING, error);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.error_reply(error)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The complete code:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]  -- Get the current time from the Redis server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local exists = redis.call(&#x27;exists&#x27;, hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if exists==0 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, &#x27;_created_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if exists==1 and redis.call(&#x27;TYPE&#x27;, hash)[&quot;ok&quot;] ~= &#x27;hash&#x27; then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       local error = &#x27;The key &#x27; .. hash .. &#x27; is not a hash&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       redis.log(redis.LOG_WARNING, error);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       return redis.error_reply(error)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Add the current timestamp to the arguments that the user passed to the function, stored in `args`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, &#x27;_updated_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Run HSET with the updated argument list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, hash, unpack(args))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function touch(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = redis.call(&#x27;TIME&#x27;)[1]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, keys[1], &#x27;_updated_at&#x27;, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_touch&#x27;, touch)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we reload the library and try again, we&#x27;ll get an error with a helpful message:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/mylib.lua | redis-cli -x FUNCTION LOAD REPLACE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL my_hset 1 my_string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">(error) The key my_string is not a hash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="refactoring">Refactoring<a class="hash-link" href="#refactoring" title="Direct link to heading">​</a></h3><p>We can notice that we have some code repetition in our library, namely the type check and the getting of the timestamp in both our functions. That&#x27;s a good opportunity for some code reuse. Let&#x27;s extract the logic into their own functions:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function get_time()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     return redis.call(&#x27;TIME&#x27;)[1]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function is_not_hash(key_name)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if redis.call(&#x27;TYPE&#x27;, key_name)[&#x27;ok&#x27;] ~= &#x27;hash&#x27; then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       return &#x27;The key &#x27; .. key_name .. &#x27; is not a hash.&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return nil</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function is only going to be called by our two existing functions and not from the outside, so that&#x27;s why we don&#x27;t need to register it. The refactored code will now look like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mylib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Get the current time from the Redis server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function get_time()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     return redis.call(&#x27;TIME&#x27;)[1]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function is_not_hash(key_name)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if redis.call(&#x27;TYPE&#x27;, key_name)[&#x27;ok&#x27;] ~= &#x27;hash&#x27; then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       return &#x27;The key &#x27; .. key_name .. &#x27; is not a hash.&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return nil</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function hset(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local time = get_time()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local exists = redis.call(&#x27;exists&#x27;, hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if exists==0 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, &#x27;_created_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash_error = is_not_hash(hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if exists==1 and hash_error ~= nil then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       return redis.error_reply(hash_error)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Add the current timestamp to the arguments that the user passed to the function, stored in `args`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, &#x27;_updated_at&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(args, time)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- Run HSET with the updated argument list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, hash, unpack(args))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function touch(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash_error = is_not_hash(hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if hash_error ~= nil then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       return redis.error_reply(hash_error)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return redis.call(&#x27;HSET&#x27;, hash, &#x27;_updated_at&#x27;, get_time())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_hset&#x27;, hset)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;my_touch&#x27;, touch)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="using-function-flags">Using Function flags<a class="hash-link" href="#using-function-flags" title="Direct link to heading">​</a></h3><p>In this step, we&#x27;ll get familiar with the use of <a href="https://redis.io/docs/manual/programmability/functions-intro/#function-flags" target="_blank" rel="noopener noreferrer">Function flags</a> - a piece of information that describes the circumstances under which a function is allowed to run. Currently, we support 5 flags:</p><ul><li><code>no-writes</code> - this flag indicates that the script only reads data but never writes.</li><li><code>allow-oom</code> - this flag allows a script to execute even when the server is out of memory (OOM).</li><li><code>allow-stale</code> - this flag enables running the script against a stale replica.</li><li><code>no-cluster</code> - this flag doesn&#x27;t allow the script to run in a clustered database.</li><li><code>allow-cross-slot-keys</code> - this flag allows a script to access keys from multiple slots.</li></ul><p>To best illustrate why function flags are useful we&#x27;ll work with a simple example that gets the basic info and favourite colours of a user. Save the following snippet in a file named <code>get_user.lua</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mynewlib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function get_user(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local user = redis.call(&#x27;HGETALL&#x27;, hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local user_colours = redis.call(&#x27;SMEMBERS&#x27;, hash .. &#x27;:colours&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(user, #user+1, &#x27;colours&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(user, #user+1, user_colours)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return user</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function(&#x27;get_user&#x27;, get_user)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we try to execute this function with <code>FCALL_RO</code> - the read-only variant of <code>FCALL</code>, we will get an error, even though it only performs read operations. In order to demonstrate that the function is read-only, we need to use the <code>no-writes</code> flag in its registration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/get_user.lua | redis-cli -x FUNCTION LOAD</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL_RO get_user 1 user:1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">(error) ERR Can not execute a script with write flag using *_ro command.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!lua name=mynewlib</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function get_user(keys, args)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local hash = keys[1]  -- Get the key name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local user = redis.call(&#x27;HGETALL&#x27;, hash)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   local user_colours = redis.call(&#x27;SMEMBERS&#x27;, hash .. &#x27;:colours&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(user, #user+1, &#x27;colours&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   table.insert(user, #user+1, user_colours)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   return user</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis.register_function{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> function_name=&#x27;get_user&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> callback=get_user,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> flags={ &#x27;no-writes&#x27; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, this will give us the expected result:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cat /path/to/get_user.lua | redis-cli -x FUNCTION LOAD REPLACE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redis-cli&gt; FCALL_RO get_user 1 user:1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1) &quot;email&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2) &quot;foo@bar.com&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3) &quot;colours&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4) 1) &quot;green&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  2) &quot;red&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  3) &quot;blue&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That&#x27;s it, you now know how to write, load and execute Redis Function. Congratulations!</p><p>For more information on Redis Functions you can check the <a href="https://redis.io/docs/manual/programmability/functions-intro/" target="_blank" rel="noopener noreferrer">Redis Functions documentation</a> and to learn more about the Lua API you can check the <a href="https://redis.io/docs/manual/programmability/lua-api/" target="_blank" rel="noopener noreferrer">Redis Lua API Reference</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/redis-developer/redis-developer/edit/master/docs/create/redis-functions/index-redis-functions.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-11-10T17:16:41.000Z">Nov 10, 2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/create"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview - All Quick Starts</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/create/azure"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Overview</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#environment-setup" class="table-of-contents__link toc-highlight">Environment setup</a></li><li><a href="#warm-up" class="table-of-contents__link toc-highlight">Warm-Up</a></li><li><a href="#maintaining-a-consistent-view-of-data-entities-through-a-logical-schema" class="table-of-contents__link toc-highlight">Maintaining a consistent view of data entities through a logical schema</a></li><li><a href="#thinking-ahead" class="table-of-contents__link toc-highlight">Thinking ahead</a></li><li><a href="#refactoring" class="table-of-contents__link toc-highlight">Refactoring</a></li><li><a href="#using-function-flags" class="table-of-contents__link toc-highlight">Using Function flags</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><svg width="785" height="158" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="shape"><defs><path d="M786.344 392.459c-41.822 22.164-258.313 110.84-305.056 135.477-46.742 24.637-72.163 23.812-108.246 6.57-36.082-17.24-267.334-111.664-309.156-131.377-41.822-19.713-42.642-33.657-1.64-49.271C103.25 338.265 332.86 247.94 381.243 229.875c48.383-18.065 65.604-18.065 106.605-2.473 41.003 15.614 256.674 100.996 297.676 115.785 41.002 14.791 42.642 27.912.82 49.273v-.001z" id="a"></path><mask id="b" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="785" height="331" fill="#fff"><use xlink:href="#a"></use></mask></defs><use mask="url(#b)" xlink:href="#a" transform="translate(-32 -216)" stroke="#465282" stroke-width="4" fill="none" fill-rule="evenodd" stroke-dasharray="3.637"></use></svg><img src="/img/code-2.png" class="code" alt=""><div class="row"><div class="col col--3"><div class="footer__logo-ctr"><span class="footer__logo-tagline">Made with &lt;/&gt; by</span><a href="https://redis.com/" target="_blank" rel="noopener" class="footerLogoLink_fGS1"><img loading="lazy" class="footer__logo" alt="Redis logo" src="/img/redis_logo_red_white_rgb.svg"></a></div></div><div class="col col--9"><div class="row footer__links"><div class="col col--4 footer__col"><h4 class="footer__title">Get Started</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/develop/">Develop</a></li><li class="footer__item"><a href="https://redis.com/redis-best-practices/introduction/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Best Practices</a></li></ul></div><div class="col col--4 footer__col"><h4 class="footer__title">Resources</h4><ul class="footer__items"><li class="footer__item"><a href="https://redis.com/community/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community</a></li><li class="footer__item"><a href="https://university.redis.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Redis University</a></li><li class="footer__item"><a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer" class="footer__link-item">Redis Commands</a></li><li class="footer__item"><a href="https://stackoverflow.com/search?q=redis" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div></div></div></div><div class="footer__copyright">Copyright: © 2024 Redis. All rights reserved. Redis and the cube logo are registered trademarks of Redis Ltd.</div></div></footer></div>
<script src="/assets/js/runtime~main.31923179.js"></script>
<script src="/assets/js/main.d3d68f51.js"></script>
</body>
</html>